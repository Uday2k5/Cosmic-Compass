
const REAL_INPUT_DATA_KM = [
    /*
    [209059050.5626659, 61079272.276863426, 39625423.619777896], 
    [208014836.4445722, 62903145.77783257, 39657018.53811728], 
    [206951505.4930857, 64721238.64047932, 39684968.90839176], 
    [205869033.76944008, 66533345.74133623, 39709248.83489603], 
    [204767399.01419464, 68339259.93923095, 39729832.46983071], 
    [203646580.6950404, 70138772.06640628, 39746694.01989959], 
    [202506560.05560797, 71931670.9202768, 39759807.75313418], 
    [201347320.1652861, 73717743.25585577, 39769148.00594987], 
    [200168845.97005853, 75496773.77888924, 39774689.19043984], 
    [198971124.3443687, 77268545.1397327, 39776405.80191113], 
    [197754144.14401856, 79032837.92800929, 39774272.42666849], 
    [196517896.26010796, 80789430.6680881, 39768263.750051394], 
    [195262373.6740211, 82538099.81542298, 39758354.56472896], 
    [193987571.51346394, 84278619.75379421, 39744519.77925855], 
    [192693487.1095585, 86010762.79349364, 39726734.42691327], 
    [191380120.05499464, 87734299.17050058, 39704973.67478311], 
    [190047472.2632435, 89448997.04669005, 39679212.83315534], 
    [188695548.02883258, 91154622.5111233, 39649427.36517959], 
    [187324354.0886827, 92850939.58246563, 39615592.89682199], 
    [185933899.6845053, 94537710.21258244, 39577685.22711411], 
    [184524196.6262576, 96214694.29136267, 39535680.33870144],
    [183095259.356652, 97881649.652822, 39489554.4086962], 
    [181647105.01671267, 99538332.08253832, 39439283.8198398], 
    [180179753.51237512, 101184495.32647331, 39384845.1719789], 
    [178693227.5821176, 102819891.1012361, 39326215.293860406], 
    [177187552.8656153, 104444269.10584559, 39263371.25524959], 
    [175662757.9734061, 106057377.03504819, 39196290.379375175], 
    [174118874.55755186, 107658960.59425202, 39124950.255706646], 
    [172555937.38328212, 109248763.51613541, 39049328.75306639], 
    [170973984.4016, 110826527.57899404, 38969404.03308138], 
    [169373056.8228327, 112391992.6268861, 38885154.56397755], 
    [167753199.1911025, 113944896.59164163, 38796559.13472009], 
    [166114459.4596955, 115484975.5168004, 38703596.869502835], 
    [164456889.06730032, 117011963.58354351, 38606247.24258922], 
    [162780543.0150887, 118525593.13868588, 38504490.09350751], 
    [161085479.94460437, 120025594.72479881, 38398305.64260207], 
    [159371762.21642834, 121511697.1125312, 38287674.50694278], 
    [157639455.98958123, 122983627.3351992, 38172577.71659362], 
    [155888631.30162296, 124441110.7257165, 38052996.73124173], 
    [154119362.14940712, 125883870.95593743, 37928913.45718743], 
    [152331726.57044142, 127311630.0784863, 37800310.26469545], 
    [150525806.724806, 128724108.57114807, 37667170.005707376], 
    [148701688.97757173, 130121025.3838949, 37529476.03191432], 
    [146859463.98166132, 131502097.9886252, 37387212.21318913], 
    [144999226.7610881, 132867042.43169113, 37240362.95637663], 
    [143121076.7945015, 134215573.38929078, 37088913.224439465], 
    [141225118.0989642, 135547404.2258, 36932848.55595747], 
    [139311459.3138787, 136862247.0551156, 36772155.08497666], 
    [137380213.7849741, 138159812.80508173, 36606819.561204255], 
    [135431499.6482627, 139439811.28506383, 36436829.370544426], 
    // This is the line that had the 'T' - it is now fixed.
    [133465439.9138657, 140701951.2567331, 36262172.55596872], 
    [131482162.54961142, 141945940.50811613, 36082837.83871402], 
    [129481800.5643044, 143171485.93096387, 35898814.63979891], 
    [127464492.09056652, 144378293.60148853, 35710093.101849146], 
    [125430380.46715117, 145566068.8645155, 35516664.111220166], 
    [123379614.320636, 146734516.4211015, 35318519.32040443], 
    [121312347.6463929, 147883340.41966712, 35115651.17070995], 
    [119228739.8887399, 149012244.5507015, 34908052.91519556], 
    [117128956.02016422, 150120932.14509752, 34695718.64184791], 
    [115013166.6195065, 151209106.2761752, 34478643.29698539]
    */
[-95139447.20078547, -211765941.0111033, -37866005.87452585],
 [-93566359.59098476, -212942693.1369387, -37744247.2834471],
  [-91986186.39721616, -214103320.6226206, -37619630.47576535], 
  [-90399083.42430708, -215247819.7613935, -37492179.67867205], 
  [-88805205.32252395, -216376187.9385771, -37361919.05447216],
   [-87204705.59498714, -217488423.6070359, -37228872.69909595], 
   [-85597736.60522503, -218584526.2631482, -37093064.64069735], 
   [-83984449.58486521, -219664496.4232588, -36954518.83833525], 
   [-82364994.64146008, -220728335.60060292, -36813259.18073326],
    [-80739520.76644544, -221776046.2826914, -36669309.48511547],
     [-79108175.84322965, -222807631.9091498, -36522693.49611498], 
     [-77471106.65540992, -223823096.8500071, -36373434.88475192], 
     [-75828458.89511171, -224822446.38442728, -36221557.24747963],
      [-74180377.17144531, -225805686.6798819, -36067084.10529588], 
      [-72527005.01907368, -226772824.77175722, -35910038.90291746],
       [-70868484.90688437, -227723868.54339364, -35750445.00801641],
        [-69204958.24675836, -228658826.7065505, -35588325.71051566],
         [-67536565.40242834, -229577708.78229448, -35423704.22194272], 
         [-65863445.69841889, -230480525.0823021, -35256603.67483936],
          [-64185737.42906103, -231367286.6905737, -35087047.12222587],
           [-62503577.86757421, -232238005.4455525, -34915057.53711818], 
           [-60817103.27520839, -233092693.9226406, -34740657.81209609],
            [-59126448.91043995, -233931365.41710842, -34563870.75892122],
             [-57431749.03821484, -234754033.92738804, -34384719.10820271], 
             [-55733136.93923264, -235560714.13874662, -34203225.50910994], 
             [-54030744.91926652, -236351421.40733168, -34019412.52912974], 
             [-52324704.31851271, -237126171.7445824, -33833302.65386717], 
             [-50615145.52096486, -237884981.8019995, -33644918.2868886], 
             [-48902197.96380845, -238627868.8562685, -33454281.74960503],
              [-47185990.14682995, -239354850.79472914, -33261415.28119481],
               [-45466649.64183705, -240065946.10118428, -33066341.03856422],
                [-43744303.1020852, -240761173.84204257, -32869081.096344322], 
                [-42019076.2717068, -241440553.6527885, -32669657.44692327], 
                [-40291093.995138854, -242104105.72477323, -32468092.00051256], 
                [-38560480.22654602, -242751850.79232123, -32264406.5852457],
                 [-36827358.03923506, -243383810.1201451, -32058622.94730887], 
                 [-35091849.6350579, -244000005.49106437, -31850762.751101572],
                  [-33354076.353799693, -244600459.19402158, -31640847.5794268],
                   [-31614158.68254956, -245185194.0123895, -31428898.933709104],
                    [-29872216.265050407, -245754233.2125657, -31214938.23424023], 
                    [-28128367.911025833, -246307600.5328467, -30998986.82045025], 
                    [-26382731.605481256, -246845320.1725776, -30781065.95120433], 
                    [-24635424.51797661, -247367416.7815727, -30561196.80512354], 
                    [-22886563.01186881, -247873915.4497992, -30339400.48092864],
                     [-21136262.653521225, -248364841.6973225, -30115697.99780677],
                      [-19384638.22147858, -248840221.46450493, -29890110.29579939],
                       [-17631803.715604696, -249300081.102455, -29662658.23621079],
                        [-15877872.366181847, -249744447.3637222, -29433362.602037158],
                         [-14122956.64296939, -250173347.39323172, -29202244.0984143],
                          [-12367168.264220279, -250586808.71945578, -28969323.35308428], 
                          [-10610618.205653809, -250984859.2458166, -28734620.91687979],
                           [-8853416.709382905, -251367527.24231654, -28498157.26422551],
                            [-7095673.292794916, -251734841.3373915, -28259952.7936565], 
                            [-5337496.757384127, -252086830.5099842, -28020027.82835218], 
                            [-3578995.1975348894, -252423524.0818313, -27778402.61668585], 
                            [-1820276.0092542807, -252744951.7099627, -27535097.33278903], 
                            [-61445.89885288743, -253051143.3794081, -27290132.07713015], 
                            [1697389.10842739, -253342129.396107, -27043526.87710707],
                             [3456123.659839489, -253617940.3800193, -26795301.68765284],
                              [5214653.066612491, -253878607.258432, -26545476.39185445]
];
        
const KM_TO_AU = 1.496e8; 


document.addEventListener('DOMContentLoaded', () => {

    const plotDiv = 'plot';
    const predictButton = document.getElementById('predictButton');
    const starsBackground = document.getElementById('stars-background'); 

    
    function generateOrbit(radius, segments = 100) {
        const x = [];
        const y = [];
        const z = [];
        for (let i = 0; i <= segments; i++) {
            const angle = (i / segments) * 2 * Math.PI;
            x.push(radius * Math.cos(angle));
            y.push(radius * Math.sin(angle));
            z.push(0); 
        }
        return { x, y, z };
    }

   
    function getKnownErosPath() {
        
        console.log("Converting KM input data to AU for plotting...");
        const x = REAL_INPUT_DATA_KM.map(row => row[0] / KM_TO_AU);
        const y = REAL_INPUT_DATA_KM.map(row => row[1] / KM_TO_AU);
        const z = REAL_INPUT_DATA_KM.map(row => row[2] / KM_TO_AU);
        return { x, y, z };
    }

    function generateStars(count) {
        for (let i = 0; i < count; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = `${Math.random() * 2 + 1}px`;
            star.style.height = star.style.width;
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * -count}s`;
            star.style.setProperty('--twinkle-duration', `${Math.random() * 5 + 3}s`);
            starsBackground.appendChild(star);
        }
    }

    generateStars(400);

    const sun = {
        x: [0], y: [0], z: [0],
        mode: 'markers',
        type: 'scatter3d',
        name: 'Sun',
        marker: {
            color: 'yellow',
            size: 10,
            symbol: 'circle',
            line: {
                color: 'rgba(255, 200, 0, 0.5)', 
                width: 8 
            }
        }
    };

    
    const earthOrbit = {
        ...generateOrbit(1), 
        mode: 'lines',
        type: 'scatter3d',
        name: 'Earth Orbit',
        line: { color: 'blue', width: 2 }
    };

    const marsOrbit = {
        ...generateOrbit(1.52), 
        mode: 'lines',
        type: 'scatter3d',
        name: 'Mars Orbit',
        line: { color: 'red', width: 2 }
    };

    
    const earthPosition = {
        x: [1], y: [0], z: [0],
        mode: 'markers',
        type: 'scatter3d',
        name: 'Earth',
        marker: { 
            color: '#0077ff',
            size: 7,
            symbol: 'circle',
            line: {
                color: 'rgba(102, 204, 255, 0.7)', 
                width: 4
            }
        }
    };

    const marsPosition = {
        x: [-1.52], y: [0], z: [0],
        mode: 'markers',
        type: 'scatter3d',
        name: 'Mars',
        marker: { 
            color: '#ff4500',
            size: 6,
            symbol: 'circle',
            line: {
                color: 'rgba(255, 154, 128, 0.7)',
                width: 4
            }
        }
    };


    const erosKnown = {
        ...getKnownErosPath(),
        mode: 'lines', 
        type: 'scatter3d',
        name: 'Eros (Known Path)',
        line: { color: 'cyan', width: 4 } 
    };


    const layout = {
        title: 'Solar System (Heliocentric)',
        margin: { l: 0, r: 0, b: 0, t: 40 },
        scene: {
            xaxis: { 
                title: 'X (AU)',
                gridcolor: 'rgba(255, 255, 255, 0.1)', 
                zerolinecolor: 'rgba(255, 255, 255, 0.25)'
            },
            yaxis: { 
                title: 'Y (AU)',
                gridcolor: 'rgba(255, 255, 255, 0.1)',
                zerolinecolor: 'rgba(255, 255, 255, 0.25)'
            },
            zaxis: { 
                title: 'Z (AU)',
                gridcolor: 'rgba(255, 255, 255, 0.1)',
                zerolinecolor: 'rgba(255, 255, 255, 0.25)'
            },
            bgcolor: '#000000',
            aspectmode: 'data'
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#e2e8f0' },
        legend: {
            bgcolor: 'rgba(30, 41, 59, 0.7)',
            bordercolor: 'rgba(0, 229, 255, 0.2)',
            borderwidth: 1,
            font: { color: '#e2e8f0' }
        }
    };

   
    const initialData = [sun, earthOrbit, marsOrbit, earthPosition, marsPosition, erosKnown];
    
   
    Plotly.newPlot(plotDiv, initialData, layout);


  
    async function fetchPrediction() {
        console.log("Calling REAL API backend at http://127.0.0.1:5000/predict");
        

        const apiUrl = 'http://127.0.0.1:5000/predict';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                
                body: JSON.stringify({ sequence: REAL_INPUT_DATA_KM })
            });

            if (!response.ok) {
                
                const errText = await response.text();
                throw new Error(`API Error: ${response.status} ${response.statusText}. Server says: ${errText}`);
            }

            const data = await response.json();

            if (data.error) {
                throw new Error(`API returned an error: ${data.error}`);
            }

            const predictedPath_KM = data.prediction;
            console.log("Prediction data (in km) received from backend.");

     
            const x_pred_au = predictedPath_KM.map(row => row[0] / KM_TO_AU);
            const y_pred_au = predictedPath_KM.map(row => row[1] / KM_TO_AU);
            const z_pred_au = predictedPath_KM.map(row => row[2] / KM_TO_AU);

            
            return {
                x: x_pred_au,
                y: y_pred_au,
                z: z_pred_au,
                mode: 'lines+markers',
                type: 'scatter3d',
                name: 'Eros (Predicted Path)',
                line: { color: 'orange', width: 4, dash: 'dash' },
                marker: { size: 3, color: 'orange' }
            };

        } catch (error) {
            console.error('Fetch Prediction Failed:', error);
            alert(`Error connecting to backend: ${error.message}\n\nIs the 'app.py' server running?`);
            return null; 
        }
    }

 
    predictButton.addEventListener('click', async () => {
        predictButton.disabled = true;
        predictButton.textContent = 'Calculating...';
        
        const predictedTrace = await fetchPrediction();
        
        
        if (predictedTrace) {
            Plotly.addTraces(plotDiv, [predictedTrace]);
        }
        
        predictButton.disabled = false;
        predictButton.textContent = 'Predict Future Path';
    });

});